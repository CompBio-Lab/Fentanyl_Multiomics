---
title: "Diff_Exp.Rmd"
output: html_document
date: "2024-05-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Differential Expression Analysis of Genes using Limma Voom 

## Load libraries 
```{r}
library(limma)
library(dplyr)
library(tidyr)
library(ggplot2)
library(EnhancedVolcano)
library(Seurat)
library(gridExtra)
```

## Load data 
```{r}
rna <- readRDS(here::here("Data", "GEX_ATAC_Seur.rds"))
```

## The rest of this Rmd was put into an Rscript and run on an HPC 

## Extract counts 
```{r}
eset <- rna@assays$RNA@layers$counts
ids <- unlist(sapply(strsplit(colnames(eset), "_"), function(i) i[[1]]))
sex <- factor(demo_10x[, "sex"], c("Male", "Female"))
drug <- factor(demo_10x[, "drug"], c("Saline", "Fentanyl"))
cell_labels <- rna@meta.data$celltype
drug <- rna@meta.data$drug
```

```{r}
# Remove the specific cell type
excluded_cell_type <- "Ex_Onecut3_Spag16_3"
cell_labels <- cell_labels[cell_labels != excluded_cell_type]
eset <- eset[, cell_labels != excluded_cell_type]
```


## Frequency of nuclei in each cell type by drug and sex 
```{r}
cc <- lapply(names(table(cell_labels)), function(cell){
  cat(cell, fill = TRUE)
  keep <- cell_labels %in% cell
  counts <- eset[, keep]
  dat <- data.frame(sex = sex[keep],
                  drug = drug[keep],
                  subj = gsub("_.*", "", colnames(counts)))
  table(dat$sex, dat$drug) %>% 
  as.data.frame() %>% 
  mutate(cell = cell)
}) %>% 
  do.call(rbind, .)

colnames(cc)[colnames(cc) == "Var1"] <- "sex"
colnames(cc)[colnames(cc) == "Var2"] <- "drug"

cc %>% 
  ggplot(aes(y = cell, x = Freq, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~drug, scales = "free") + ggtitle("Frequency of Nuclei in Each Cell Type by Sex and Drug")

summary(lm(Freq ~ sex*drug, data = cc))

```

## Limma Analysis 
### Limma has a built-in approach for analyzing repeated measures data using duplicateCorrelation(). The model can handle a single random effect, and forces the magnitude of the random effect to be the same across all genes.

## paralellized limma with DupCor 

```{r}
eset <- as.matrix(eset)
library(parallel)
cl <- makeCluster(detectCores())
clusterExport(cl, c("cell_labels", "sex", "drug", "eset"))
top <- parLapply(cl, names(table(cell_labels)), function(cell){
  library(limma);
  cat(cell, fill = TRUE)
  keep <- cell_labels %in% cell
  counts <- eset[, keep]
  dat <- data.frame(sex = sex[keep],
                    drug = drug[keep],
                    subj = gsub("_.*", "", colnames(counts)))
  
  design <- model.matrix(~sex*drug, data = dat)
  vobj_tmp <- voom(counts, design, plot = FALSE)
  dupcor <- duplicateCorrelation(vobj_tmp, design, block = dat$subj)
  vobj <- voom(counts, design, plot = FALSE, block = dat$subj, correlation = dupcor$consensus)
  dupcor <- duplicateCorrelation(vobj, design, block = dat$subj)
  fitDupCor <- lmFit(vobj, design, block = dat$subj, correlation = dupcor$consensus)
  fitDupCor <- eBayes(fitDupCor)
  top_FvsM <- topTable(fitDupCor, coef = "sexFemale", adjust.method = "BH", number = nrow(fitDupCor))
  top_FvsM$comparison <- "Female_vs_Male"
  top_FvsM$gene <- rownames(top_FvsM)
  top_SvsF <- topTable(fitDupCor, coef = "drugFentanyl", adjust.method = "BH", number = nrow(fitDupCor))
  top_SvsF$comparison <- "Saline_vs_Fentanyl"
  top_SvsF$gene <- rownames(top_SvsF)
  top_int <- topTable(fitDupCor, coef = "sexFemale:drugFentanyl", adjust.method = "BH", number = nrow(fitDupCor))
  top_int$comparison <- "drug x sex interaction"
  top_int$gene <- rownames(top_int)
  top <- rbind(top_FvsM, top_SvsF, top_int)
  top$cell <- cell
top }) 
stopCluster(cl)

top <- Reduce("rbind", top)
```

## Save top table 
```{r}
saveRDS(top, file = "top_gex.rds")
```


## Load top table obtained from above run 
```{r}
top <- readRDS(here::here("Data", "top_gex.rds"))
```


## Plot DEGs for all cell types for each interaction  
```{r}
top %>% dplyr::filter(adj.P.Val < 0.001) %>% 
  group_by(cell, comparison) %>% 
  summarise(n = n()) %>% 
  ungroup %>% 
  complete(cell, comparison) %>% 
  mutate(comparison = factor(comparison, levels = c("drug x sex interaction", "Female_vs_Male", "Saline_vs_Fentanyl"))) %>% 
  ggplot(aes(x = reorder(cell, -n), y = n, fill = comparison)) + 
  geom_bar(stat = "identity", position = "dodge") + scale_y_log10() + 
  ylab("Number of differentially expressed genes (FDR<1%)") +   
  xlab("Cell-type") +   
  theme_classic() +   
  theme(legend.position = c(0.9,0.9)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

top %>% 
  group_by(cell, comparison) %>% 
  arrange(adj.P.Val) %>% 
  mutate(n = 1:n()) %>% 
  ggplot(aes(x = n, y = adj.P.Val, col= cell)) +
  geom_line() +
  facet_wrap(~comparison) 

```

## Filtering top table  
```{r}
# Remove NAs
top <- top[complete.cases(top$adj.P.Val), ]

# subset based on comparison and adjusted p value 
top_fxs <- top[top$comparison == "Saline_vs_Fentanyl" & top$adj.P.Val < 1e-08, ]

ex_crym <- top_fxs[top_fxs$cell == "Endo_Flt1_Lrg1_1", ]

sex <- rna@meta.data$sex
keep <- cell_labels %in% "Endo_Flt1_Lrg1_1"
counts <- eset[, keep]
dat <- data.frame(sex = sex[keep],
                  drug = drug[keep],
                  subj = gsub("_.*", "", colnames(counts)))
design <- model.matrix(~sex*drug, data = dat)
vobj_tmp <- voom(counts, design, plot = FALSE)
counts <- vobj_tmp$E
gene <- "St6galnac3"

dat %>% 
  mutate(gene = counts[gene, ]) %>% 
  group_by(sex, drug, subj) %>% 
  summarise(avg = mean(gene)) %>% 
  ggplot(aes(x = drug, y = avg)) +
  geom_boxplot()


plot(counts[gene, ]~factor(drug[keep]))
fit <- lm(counts[gene, ]~sex*drug, data = dat)
summary(lm(counts[gene, ]~sex*drug, data = dat))

termplot(fit)

# Filter for each cell type  
Endo_Flt1_Lrg1_1 <- top_dxs[top_dxs$cell == "Endo_Flt1_Lrg1_1", ]
Ex_C1ql4 <- top_dxs[top_dxs$cell == "Ex_C1ql4_Drd1_3", ]
Ex_Ebf2 <- top_dxs[top_dxs$cell == "Ex_Ebf2_Layn", ]
Ex_Plekhg1 <- top_dxs[top_dxs$cell == "Ex_Plekhg1_Nox4_Kcp_2", ]
Ex_Sim1 <- top_dxs[top_dxs$cell == "Ex_Sim1_Aox3_1", ]
Ex_Tfap2b <- top_dxs[top_dxs$cell == "Ex_Tfap2b_Ccdc172_Calcr", ]
Fibro_Eya2 <- top_dxs[top_dxs$cell == "Fibro_Eya2_Ccdc192_2", ]
Inh_Frm7 <- top_dxs[top_dxs$cell == "Inh_Frm7_Otop1_1", ]

```

## Volcano plots using EnhancedVolcano 
```{r}
plot1 <- EnhancedVolcano(Endo_Flt1_Lrg1_1,
                         lab = Endo_Flt1_Lrg1_1$gene,
                         x = 'logFC',
                         y = 'P.Value',
                         title = "Endo_Flt1_Lrg1_1")

plot2 <- EnhancedVolcano(Ex_C1ql4,
                         lab = Ex_C1ql4$gene,
                         x = 'logFC',
                         y = 'P.Value',
                        title = "Ex_C1ql4_Asb4")

plot3 <- EnhancedVolcano(Ex_Ebf2,
                         lab = Ex_Ebf2$gene,
                         x = 'logFC',
                         y = 'P.Value',
                        title = "Ex_Ebf2_Layn")


plot4 <- EnhancedVolcano(Ex_Tfap2b,
                         lab = Ex_Tfap2b$gene,
                         x = 'logFC',
                         y = 'P.Value',
                        title = "Ex_Tfap2b_Ccdc172_Calcr")

grid.arrange(plot1, plot2, plot3, plot4, ncol=2, padding = 1)
```

