---
title: "spatial_clustering"
output: html_document
date: "2024-07-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Spatial clustering of spatial data using BayesSpace 

## Load libraries 
```{r}
library(BayesSpace)
library(ggplot2)
library(SingleCellExperiment)
library(scran)
library(scater)
library(dplyr)
library(Seurat)
library(dbplyr)
```

## Pre-processing cosmx seurat object 
```{r}
# load data 
cosmx <- readRDS(here::here("Data", "cosmx.rds"))
cosmx_eset <- read.csv(here::here("Data", "rat_brain", "Run5618_RtBrain_tx_file.csv"))
polygons <- read.csv(here::here("Data", "rat_brain", "Run5618_RtBrain-polygons.csv"))

# create df with cellID_fov column and coordinates only from cosmx_eset

# cosmx_eset
coord <- cosmx_eset %>%
  mutate(cellID_fov = paste(cell_ID, fov, sep = "_")) %>%
  select(cellID_fov, x_global_px, y_global_px) %>% group_by(cellID_fov) %>% slice(1) %>%
  as.data.frame()

polygons_coord <- polygons %>%
  mutate(cellID_fov = paste(cellID, fov, sep = "_")) %>%
  select(cellID_fov, x_local_px, y_local_px) %>% group_by(cellID_fov) %>% slice(1) %>%
  as.data.frame()

# make cellID_fov as rows 
rownames(coord) <- coord$cellID_fov
all_coords <- left_join(coord, polygons_coord, by = "cellID_fov")
rownames(all_coords) <- coord$cellID_fov

# add coord df to metadata in seurat object
rownames_cosmx <- rownames(cosmx@meta.data)
coord_subset <- all_coords[intersect(rownames(all_coords), rownames_cosmx), ]
cosmx <- AddMetaData(cosmx, metadata = coord_subset[, c("x_global_px", "y_global_px", "x_local_px", "y_local_px")])

# add sample ID to meta data 
# Load fov annotations
fov_annotations <- read.csv(here::here("Data", "fov_annotations.csv"))
fov_annotations$fov <- as.character(fov_annotations$fov)

# Extract the fov information from the Seurat object
fov_info <- sub(".*_(.*)", "\\1", rownames(cosmx@meta.data))

# Add the fov info as a new column in the Seurat object's metadata
cosmx@meta.data$fov <- fov_info

# Preserve the original row names
original_rownames <- rownames(cosmx@meta.data)

# Join the fov annotations to get sample IDs
metadata_df <- cosmx@meta.data %>%
  left_join(fov_annotations, by = c("fov" = "fov"))

# Reassign the original row names
rownames(metadata_df) <- original_rownames

# Update the Seurat object's metadata
cosmx@meta.data <- metadata_df
```

## convert seurat to singlecell experiment 
```{r}
# To single cell exp
sce <- as.SingleCellExperiment(cosmx)
#colData(sce_r3) <- cbind(colData(sce_r3))
sce@colData$imagerow <- sce@colData$y_global_px
sce@colData$row <- sce@colData$y_local_px
sce@colData$imagecol <- sce@colData$x_global_px
sce@colData$col <- sce@colData$x_local_px
```

## Processing the data
```{r}
set.seed(101)
dec <- scran::modelGeneVar(sce)
top <- scran::getTopHVGs(dec, n = 2000)

set.seed(102)
sce <- scater::runPCA(sce, subset_row=top)
## Add BayesSpace metadata
sce <- spatialPreprocess(sce, skip.PCA=TRUE)
```

## Clustering with BayesSpace 
```{r}
q <- 7  # Number of clusters
d <- 30  # Number of PCs

## Run BayesSpace clustering
set.seed(104)


sce <- spatialCluster(sce, q=q, d=d,
                        nrep=500, gamma=3, save.chain=TRUE, burn.in = 100)

#labels <- dplyr::recode(sce$spatial.cluster, 3, 4, 5, 6, 2, 7 ,1 )
```


```{r}

# Extract spatial coordinates and cluster labels
spatial_data <- as.data.frame(colData(sce))
spatial_data$labels <- labels  # Replace 'labels' with your actual cluster labels

# Plot using ggplot2
ggplot(spatial_data, aes(x = imagecol, y = imagerow, color = factor(spatial.cluster))) +
  geom_point(size = 0.5) +
  scale_color_viridis_d(option = "A", labels = 1:7) +
  labs(title = "BayesSpace Clustering") +
  theme_minimal()

ggplot(spatial_data, aes(x = imagecol, y = imagerow, color = factor(spatial.cluster))) +
  geom_point() +
  facet_wrap(~ id, scales = "free") +
  scale_color_viridis_d(option = "A") +  # Adjust color scale as needed
  labs(title = "BayesSpace Clustering", x = "Image Row", y = "Image Column") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

## save sce as an rds object 
```{r}
saveRDS(sce, file = here::here("Data", "sce.rds"))
```

