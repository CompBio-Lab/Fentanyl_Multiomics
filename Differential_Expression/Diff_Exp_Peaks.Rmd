---
title: "Diff_Exp_Peaks.Rmd"
output: html_document
date: "2024-05-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Differential Expression Analysis of Peaks using Limma Voom
## In order to get the top table we ran the R script on an HPC due to large number of fragments.

## Load libraries 
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(EnhancedVolcano)
library(gridExtra)
```


## load top table 
```{r}
top_atac <- readRDS("/Users/rishikadaswani/Desktop/Fentanyl_Multiomics/Data/top_atac.rds")
```


## Plot DEGs for all cell types for each interaction  
```{r}
top_atac %>% filter(adj.P.Val < 0.01) %>% 
  group_by(cell, comparison) %>% 
  summarise(n = n()) %>% 
  ungroup %>% 
  complete(cell, comparison) %>% 
  mutate(comparison = factor(comparison, levels = c("drug x sex interaction", "Female_vs_Male", "Saline_vs_Fentanyl"))) %>% 
  ggplot(aes(x = reorder(cell, -n), y = n, fill = comparison)) + 
  geom_bar(stat = "identity", position = "dodge") + scale_y_log10() + 
  ylab("Number of differentially expressed peaks (FDR<1%)") +   
  xlab("Cell-type") +   
  theme_classic() +   
  theme(legend.position = c(0.9,0.9)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

top_atac %>% 
  group_by(cell, comparison) %>% 
  arrange(adj.P.Val) %>% 
  mutate(n = 1:n()) %>% 
  ggplot(aes(x = n, y = adj.P.Val, col= cell)) +
  geom_line() +
  facet_wrap(~comparison) 

```


## Filtering top table 
```{r}
# filter only for the drug x sex interaction 
top_dxs <- top_atac[top_atac$comparison == "drug x sex interaction", ]

Chol_Isl2_Gata6_4 <- top_dxs[top_dxs$cell == "Chol_Isl2_Gata6_4", ]
```


